<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CCCD API Demo</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
      label { display: block; font-size: 12px; color: #444; margin-bottom: 6px; }
      input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; min-width: 220px; }
      button { padding: 10px 14px; border: 0; border-radius: 8px; background: #111; color: #fff; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      pre { background: #0b1020; color: #e7e7e7; padding: 14px; border-radius: 10px; overflow: auto; }
      .hint { color: #555; font-size: 13px; margin-top: 10px; }
      .ok { color: #0a7a2f; font-weight: 600; }
      .bad { color: #b00020; font-weight: 600; }
      a { color: #0b57d0; }
    </style>
  </head>
  <body>
    <h2>CCCD API Demo</h2>
    <div class="hint">
      Trang n√†y d√πng ƒë·ªÉ test local nhanh cho endpoint <code>POST /v1/cccd/parse</code>.
      Health check: <a href="/health">/health</a>
    </div>

    <div style="margin-top:16px" class="row">
      <div>
        <label>CCCD (12 s·ªë)</label>
        <input id="cccd" value="079203012345" />
      </div>
      <div>
        <label>province_version (tu·ª≥ ch·ªçn)</label>
        <select id="province_version">
          <option value="">(m·∫∑c ƒë·ªãnh)</option>
          <option value="legacy_63">legacy_63</option>
          <option value="current_34">current_34</option>
        </select>
      </div>
      <div>
        <label>API Key (n·∫øu ƒë√£ c·∫•u h√¨nh)</label>
        <input id="api_key" placeholder="X-API-Key" />
      </div>
      <button id="btn">Parse</button>
    </div>

    <!-- Security status -->
    <div style="margin-top:16px; padding:12px; border-radius:8px; background: {% if api_key_required %}#e8f5e9{% else %}#fff3e0{% endif %};">
      {% if api_key_required %}
        <strong style="color:#2e7d32;">üîê API Key ƒëang B·∫¨T</strong>
        <p style="margin:6px 0 0; font-size:13px; color:#555;">
          Server y√™u c·∫ßu API key. Key hi·ªán t·∫°i: <code>{{ configured_key }}</code><br>
          ‚ñ∏ ƒê·ªÉ tr·ªëng √¥ "API Key" ‚Üí <span class="bad">401</span><br>
          ‚ñ∏ Nh·∫≠p sai key ‚Üí <span class="bad">401</span><br>
          ‚ñ∏ Nh·∫≠p ƒë√∫ng key ‚Üí <span class="ok">200</span>
        </p>
      {% else %}
        <strong style="color:#e65100;">üîì API Key ƒëang T·∫ÆT</strong>
        <p style="margin:6px 0 0; font-size:13px; color:#555;">
          Server ch∆∞a y√™u c·∫ßu API key (m·ªçi request ƒë·ªÅu ƒë∆∞·ª£c ch·∫•p nh·∫≠n).<br>
          <b>ƒê·ªÉ test t√≠nh nƒÉng API Key:</b><br>
          1. M·ªü file <code>.env</code><br>
          2. ƒê·∫∑t <code>API_KEY=mysecretkey123</code> (ho·∫∑c b·∫•t k·ª≥ gi√° tr·ªã n√†o)<br>
          3. Restart server (<code>Ctrl+C</code> r·ªìi <code>py run.py</code>)<br>
          4. Quay l·∫°i trang n√†y v√† test l·∫°i.
        </p>
      {% endif %}
    </div>

    <div style="margin-top:16px" class="hint">
      K·ª≥ v·ªçng:
      <ul>
        <li>Nh·∫≠p CCCD ƒë√∫ng 12 s·ªë ‚Üí <span class="ok">HTTP 200</span>, <code>success=true</code>, <code>is_valid_format=true</code></li>
        <li>Nh·∫≠p CCCD sai (v√≠ d·ª• "123") ‚Üí <span class="bad">HTTP 400</span>, <code>success=false</code>, <code>is_valid_format=false</code></li>
        <li>Nh·∫≠p CCCD ƒë√∫ng format nh∆∞ng nƒÉm sinh ·ªü t∆∞∆°ng lai (v√≠ d·ª• 2099) ‚Üí <span class="ok">HTTP 200</span>, <code>is_plausible=false</code>, <code>warnings</code> c√≥ <code>birth_year_in_future</code></li>
        <li>N·∫øu <code>province_code</code> kh√¥ng c√≥ trong mapping ‚Üí <code>province_name=null</code> v√† <code>warnings</code> c√≥ <code>province_code_not_found</code></li>
      </ul>
    </div>

    <h3>K·∫øt qu·∫£</h3>
    <div class="hint">Status: <span id="status">-</span></div>
    <pre id="out">{}</pre>

    <script>
      const btn = document.getElementById("btn");
      const out = document.getElementById("out");
      const statusEl = document.getElementById("status");
      const cccdEl = document.getElementById("cccd");
      const pvEl = document.getElementById("province_version");
      const apiKeyEl = document.getElementById("api_key");

      async function run() {
        btn.disabled = true;
        statusEl.textContent = "loading...";
        out.textContent = "";

        const rawCccd = (cccdEl.value || "").trim();
        const payload = {};
        // Allow testing "missing cccd" by leaving the field blank
        if (rawCccd !== "") payload.cccd = rawCccd;
        if (pvEl.value) payload.province_version = pvEl.value;

        try {
          const headers = { "Content-Type": "application/json" };
          const apiKey = (apiKeyEl.value || "").trim();
          if (apiKey) headers["X-API-Key"] = apiKey;

          const resp = await fetch("/v1/cccd/parse", {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });

          statusEl.textContent = resp.status;
          const text = await resp.text();
          try {
            out.textContent = JSON.stringify(JSON.parse(text), null, 2);
          } catch {
            out.textContent = text;
          }
        } catch (e) {
          statusEl.textContent = "error";
          out.textContent = String(e);
        } finally {
          btn.disabled = false;
        }
      }

      btn.addEventListener("click", run);
    </script>
  </body>
</html>


