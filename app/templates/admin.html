<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - CCCD API</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: #f5f5f5; }
      .container { max-width: 1200px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      h1 { margin-top: 0; color: #333; }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin: 24px 0; }
      .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #0b57d0; }
      .stat-card h3 { margin: 0 0 8px; font-size: 14px; color: #666; text-transform: uppercase; }
      .stat-card .value { font-size: 32px; font-weight: 600; color: #333; }
      .tier-stats { margin-top: 24px; }
      .tier-stats table { width: 100%; border-collapse: collapse; }
      .tier-stats th, .tier-stats td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
      .tier-stats th { background: #f8f9fa; font-weight: 600; }
      .tier-stats tr:hover { background: #f8f9fa; }
      .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
      .badge-free { background: #e3f2fd; color: #1976d2; }
      .badge-premium { background: #fff3e0; color: #f57c00; }
      .badge-ultra { background: #f3e5f5; color: #7b1fa2; }
      .error { color: #d32f2f; background: #ffebee; padding: 12px; border-radius: 8px; margin: 16px 0; }
      .loading { text-align: center; padding: 40px; color: #666; }
      .ok { color: #0a7a2f; font-weight: 600; }
      .bad { color: #b00020; font-weight: 600; }
      .hint { color: #555; font-size: 13px; margin-top: 10px; }
      button { padding: 10px 16px; border: 0; border-radius: 8px; background: #0b57d0; color: white; cursor: pointer; font-size: 14px; }
      button:hover { background: #0a4fb8; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; min-width: 300px; }
      .form-group { margin: 16px 0; }
      label { display: block; margin-bottom: 6px; font-size: 14px; color: #555; }
      .form-row { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
      .form-row > div { flex: 1; min-width: 200px; }
      .success { color: #2e7d32; background: #e8f5e9; padding: 12px; border-radius: 8px; margin: 16px 0; }
      .key-display { background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; word-break: break-all; }
      .key-display strong { color: #d32f2f; }
      .section { margin-top: 32px; padding-top: 24px; border-top: 2px solid #e0e0e0; }
      .section h2 { margin-top: 0; }
      .payments-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .payments-table th, .payments-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
      .payments-table th { background: #f8f9fa; font-weight: 600; }
      .payments-table tr:hover { background: #f8f9fa; }
      .btn-approve { padding: 6px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-right: 8px; }
      .btn-approve:hover { background: #218838; }
      .btn-reject { padding: 6px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
      .btn-reject:hover { background: #c82333; }
      .btn-actions { display: flex; gap: 8px; align-items: center; }
      .amount { font-weight: 600; color: #28a745; }
      .user-info { color: #495057; }
      .user-email { color: #0b57d0; font-weight: 500; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Admin Dashboard</h1>

      <div class="form-group">
        <label>Admin Secret Key</label>
        <input id="adminKey" type="password" placeholder="Nh·∫≠p ADMIN_SECRET t·ª´ .env" />
        <button onclick="loadStats()">T·∫£i th·ªëng k√™</button>
      </div>

      <div id="error" class="error" style="display:none;"></div>
      <div id="loading" class="loading" style="display:none;">ƒêang t·∫£i...</div>

      <div id="stats" style="display:none;">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Requests h√¥m nay</h3>
            <div class="value" id="requestsToday">0</div>
          </div>
        </div>

        <div class="tier-stats">
          <h2>T·ªïng quan theo Tier</h2>
          <table>
            <thead>
              <tr>
                <th>Tier</th>
                <th>T·ªïng Keys</th>
                <th>Keys ƒëang ho·∫°t ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="tierTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h2>üß™ Test API</h2>
        <p style="color: #666; margin-bottom: 16px;">
          Test API key tr·ª±c ti·∫øp t·∫°i ƒë√¢y:
        </p>
        
        <!-- Security status -->
        <div style="margin-bottom: 16px; padding: 12px; border-radius: 8px; background: {% if api_key_required %}#e8f5e9{% else %}#fff3e0{% endif %};">
          {% if api_key_required %}
            <strong style="color:#2e7d32;">üîê API Key ƒëang B·∫¨T</strong>
            <p style="margin:6px 0 0; font-size:13px; color:#555;">
              Server y√™u c·∫ßu API key. Mode: <code>{{ api_key_mode }}</code>
              {% if api_key_mode == 'simple' %}
                <br>Key hi·ªán t·∫°i: <code>{{ configured_key }}</code>
              {% endif %}
            </p>
          {% else %}
            <strong style="color:#e65100;">üîì API Key ƒëang T·∫ÆT</strong>
            <p style="margin:6px 0 0; font-size:13px; color:#555;">
              Server ch∆∞a y√™u c·∫ßu API key (m·ªçi request ƒë·ªÅu ƒë∆∞·ª£c ch·∫•p nh·∫≠n).
            </p>
          {% endif %}
        </div>
        
        <!-- Demo form -->
        <div class="form-group">
          <div class="form-row">
            <div>
              <label>CCCD (12 s·ªë)</label>
              <input id="demoCccd" value="079203012345" maxlength="12" pattern="[0-9]{12}" inputmode="numeric" style="min-width: 200px;" />
            </div>
            <div>
              <label>province_version (tu·ª≥ ch·ªçn)</label>
              <select id="demoProvinceVersion" style="min-width: 200px;">
                <option value="">(m·∫∑c ƒë·ªãnh)</option>
                <option value="legacy_63">legacy_63</option>
                <option value="current_34">current_34</option>
              </select>
            </div>
            <div>
              <label>API Key ƒë·ªÉ test</label>
              <input id="demoApiKey" type="password" placeholder="Nh·∫≠p API Key ƒë·ªÉ test" style="min-width: 200px;" />
            </div>
            <div>
              <button onclick="testApi()" style="margin-top: 24px;">Test Parse</button>
            </div>
          </div>
        </div>
        
        <div id="demoError" class="error" style="display:none;"></div>
        <div id="demoResult" style="display:none;">
          <h3 style="margin-top: 16px;">K·∫øt qu·∫£</h3>
          <div class="hint">Status: <span id="demoStatus">-</span></div>
          <pre id="demoOutput" style="background: #0b1020; color: #e7e7e7; padding: 14px; border-radius: 10px; overflow: auto; max-height: 400px;">{}</pre>
        </div>
      </div>

      <div class="section">
        <h2>üîë T·∫°o API Key m·ªõi</h2>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label>Tier</label>
              <select id="createTier">
                <option value="free">Free (10 req/ph√∫t)</option>
                <option value="premium">Premium (100 req/ph√∫t)</option>
                <option value="ultra" selected>Ultra (1000 req/ph√∫t)</option>
              </select>
            </div>
            <div>
              <label>S·ªë ng√†y h·ª£p l·ªá (ƒë·ªÉ tr·ªëng = vƒ©nh vi·ªÖn)</label>
              <input id="createDays" type="number" placeholder="30" min="1" step="1" pattern="[0-9]+" />
            </div>
          </div>
          <button onclick="createKey()">T·∫°o Key</button>
        </div>

        <div id="createError" class="error" style="display:none;"></div>
        <div id="createSuccess" class="success" style="display:none;">
          <strong>‚ö†Ô∏è L∆ØU √ù: Key ch·ªâ hi·ªÉn th·ªã 1 l·∫ßn n√†y. H√£y copy v√† l∆∞u ngay!</strong>
          <div class="key-display" id="createdKey"></div>
        </div>
      </div>
      
      <!-- Pending Payments Section -->
      <div class="section">
        <h2>üí∞ Pending Payments - Ch·ªù X√°c Nh·∫≠n</h2>
        <div id="paymentsContainer">
          <p style="text-align: center; color: #666; padding: 40px;">
            Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n v√† nh·∫•n "T·∫£i th·ªëng k√™" ƒë·ªÉ xem pending payments
          </p>
        </div>
      </div>
      
      <!-- User Management Section -->
      <div class="section">
        <h2>üë• Qu·∫£n L√Ω Users</h2>
        <p style="color: #666; margin-bottom: 16px;">
          Danh s√°ch users v·ªõi pagination. Admin c√≥ th·ªÉ t√¨m ki·∫øm v√† thay ƒë·ªïi tier tr·ª±c ti·∫øp.
        </p>
        
        <div class="form-group">
          <div class="form-row" style="align-items: center;">
            <div style="flex: 1;">
              <label>T√¨m ki·∫øm (Email ho·∫∑c T√™n)</label>
              <input id="userSearchInput" type="text" placeholder="Nh·∫≠p email ho·∫∑c t√™n..." style="min-width: 300px;" />
            </div>
            <div>
              <button onclick="loadUsersList()">T√¨m</button>
            </div>
          </div>
        </div>
        
        <div id="usersContainer">
          <p style="text-align: center; color: #666; padding: 40px;">
            Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n v√† nh·∫•n "T·∫£i th·ªëng k√™" ƒë·ªÉ xem danh s√°ch users
          </p>
        </div>
      </div>
    </div>

    <script>
      function showError(msg) {
        document.getElementById("error").textContent = msg;
        document.getElementById("error").style.display = "block";
        document.getElementById("stats").style.display = "none";
      }

      function hideError() {
        document.getElementById("error").style.display = "none";
      }

      async function loadStats() {
        const adminKey = document.getElementById("adminKey").value.trim();
        if (!adminKey) {
          showError("Vui l√≤ng nh·∫≠p Admin Secret Key");
          return;
        }

        document.getElementById("loading").style.display = "block";
        document.getElementById("stats").style.display = "none";
        hideError();

        try {
          const resp = await fetch("/admin/stats", {
            headers: { "X-Admin-Key": adminKey }
          });

          if (!resp.ok) {
            const data = await resp.json();
            throw new Error(data.error || `HTTP ${resp.status}`);
          }

          const data = await resp.json();

          // Update requests today
          document.getElementById("requestsToday").textContent = data.requests_today || 0;

          // Update tier stats
          const tbody = document.getElementById("tierTableBody");
          tbody.innerHTML = "";

          const tiers = data.tiers || {};
          const tierOrder = ["free", "premium", "ultra"];
          const tierLabels = { free: "Free", premium: "Premium", ultra: "Ultra" };

          tierOrder.forEach(tier => {
            if (tiers[tier]) {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td><span class="badge badge-${tier}">${tierLabels[tier]}</span></td>
                <td>${tiers[tier].total || 0}</td>
                <td>${tiers[tier].active || 0}</td>
              `;
              tbody.appendChild(row);
            }
          });

          document.getElementById("loading").style.display = "none";
          document.getElementById("stats").style.display = "block";
          
          // Load pending payments sau khi load stats th√†nh c√¥ng
          loadPendingPayments(adminKey);
        } catch (e) {
          document.getElementById("loading").style.display = "none";
          showError("L·ªói: " + e.message);
        }
      }
      
      async function loadPendingPayments(adminKey) {
        if (!adminKey) {
          return;
        }
        
        try {
          const resp = await fetch("/admin/payments", {
            headers: { "X-Admin-Key": adminKey }
          });
          
          if (!resp.ok) {
            if (resp.status === 403) {
              document.getElementById("paymentsContainer").innerHTML = 
                '<p style="text-align: center; color: #d32f2f; padding: 40px;">‚ùå Admin key kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.</p>';
            } else {
              throw new Error(`HTTP ${resp.status}`);
            }
            return;
          }
          
          const data = await resp.json();
          const payments = data.payments || [];
          
          if (payments.length === 0) {
            document.getElementById("paymentsContainer").innerHTML = 
              '<p style="text-align: center; color: #666; padding: 40px;">Kh√¥ng c√≥ payment n√†o ƒëang ch·ªù x·ª≠ l√Ω</p>';
            return;
          }
          
          // Render payments table
          let html = '<table class="payments-table"><thead><tr><th>Ng√†y</th><th>Kh√°ch h√†ng</th><th>S·ªë ti·ªÅn</th><th>Ph∆∞∆°ng th·ª©c</th><th>Ghi ch√∫</th><th>Thao t√°c</th></tr></thead><tbody>';
          
          payments.forEach(payment => {
            const dateStr = payment.created_at ? new Date(payment.created_at).toLocaleString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : 'N/A';
            
            const amountStr = payment.currency === 'VND' 
              ? new Intl.NumberFormat('vi-VN').format(payment.amount) + ' ' + payment.currency
              : '$' + payment.amount.toFixed(2) + ' ' + payment.currency;
            
            html += `
              <tr id="payment-row-${payment.id}">
                <td>${dateStr}</td>
                <td class="user-info">
                  <div class="user-email">${payment.user_email || 'N/A'}</div>
                  <div style="font-size: 12px; color: #666;">${payment.user_name || 'N/A'}</div>
                </td>
                <td class="amount">${amountStr}</td>
                <td>${payment.payment_gateway || 'N/A'}</td>
                <td>${payment.notes || '-'}</td>
                <td>
                  <div class="btn-actions">
                    <button class="btn-approve" onclick="approvePayment(${payment.id})">
                      ‚úÖ Approve
                    </button>
                    <button class="btn-reject" onclick="rejectPayment(${payment.id})">
                      ‚ùå Reject
                    </button>
                  </div>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          document.getElementById("paymentsContainer").innerHTML = html;
        } catch (e) {
          document.getElementById("paymentsContainer").innerHTML = 
            '<p style="text-align: center; color: #d32f2f; padding: 40px;">‚ùå L·ªói khi t·∫£i pending payments: ' + e.message + '</p>';
        }
      }

      // Enter key to load
      document.getElementById("adminKey").addEventListener("keypress", (e) => {
        if (e.key === "Enter") loadStats();
      });
      
      // Test API function
      async function testApi() {
        const cccd = document.getElementById("demoCccd").value.trim();
        const provinceVersion = document.getElementById("demoProvinceVersion").value;
        const apiKey = document.getElementById("demoApiKey").value.trim();
        
        document.getElementById("demoError").style.display = "none";
        document.getElementById("demoResult").style.display = "none";
        
        const payload = {};
        if (cccd) payload.cccd = cccd;
        if (provinceVersion) payload.province_version = provinceVersion;
        
        try {
          const headers = { "Content-Type": "application/json" };
          if (apiKey) headers["X-API-Key"] = apiKey;
          
          const resp = await fetch("/v1/cccd/parse", {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });
          
          const statusEl = document.getElementById("demoStatus");
          statusEl.textContent = resp.status;
          
          const text = await resp.text();
          try {
            const json = JSON.parse(text);
            document.getElementById("demoOutput").textContent = JSON.stringify(json, null, 2);
            
            if (resp.status === 200) {
              statusEl.className = "ok";
            } else if (resp.status === 401 || resp.status === 400) {
              statusEl.className = "bad";
            } else {
              statusEl.className = "";
            }
          } catch {
            document.getElementById("demoOutput").textContent = text;
            statusEl.className = "bad";
          }
          
          document.getElementById("demoResult").style.display = "block";
        } catch (e) {
          document.getElementById("demoError").textContent = "L·ªói: " + e.message;
          document.getElementById("demoError").style.display = "block";
        }
      }
      

      // Ch·ªâ cho ph√©p nh·∫≠p s·ªë 0-9 v√†o √¥ "S·ªë ng√†y"
      document.getElementById("createDays").addEventListener("keypress", (e) => {
        // Cho ph√©p: s·ªë 0-9, Backspace, Delete, Arrow keys, Tab
        const allowed = /[0-9]|Backspace|Delete|ArrowLeft|ArrowRight|Tab/;
        if (!allowed.test(e.key)) {
          e.preventDefault();
        }
      });

      // NgƒÉn paste text kh√¥ng ph·∫£i s·ªë
      document.getElementById("createDays").addEventListener("paste", (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData("text");
        const numbersOnly = paste.replace(/[^0-9]/g, "");
        if (numbersOnly) {
          e.target.value = numbersOnly;
        }
      });

      async function createKey() {
        const adminKey = document.getElementById("adminKey").value.trim();
        const tier = document.getElementById("createTier").value;
        const days = document.getElementById("createDays").value.trim();

        if (!adminKey) {
          showError("Vui l√≤ng nh·∫≠p Admin Secret Key tr∆∞·ªõc");
          return;
        }

        document.getElementById("createError").style.display = "none";
        document.getElementById("createSuccess").style.display = "none";

        try {
          const body = { tier };
          if (days) {
            const daysNum = parseInt(days);
            if (isNaN(daysNum) || daysNum < 1) {
              document.getElementById("createError").textContent = "S·ªë ng√†y ph·∫£i l√† s·ªë nguy√™n >= 1";
              document.getElementById("createError").style.display = "block";
              return;
            }
            body.days = daysNum;
          }

          const resp = await fetch("/admin/keys/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Key": adminKey
            },
            body: JSON.stringify(body)
          });

          if (!resp.ok) {
            const data = await resp.json();
            throw new Error(data.error || `HTTP ${resp.status}`);
          }

          const data = await resp.json();
          
          // Hi·ªÉn th·ªã key
          document.getElementById("createdKey").textContent = data.api_key;
          document.getElementById("createSuccess").style.display = "block";
          
          // Reset form
          document.getElementById("createDays").value = "";
          
          // Reload stats ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng keys
          loadStats();
        } catch (e) {
          document.getElementById("createError").textContent = "L·ªói: " + e.message;
          document.getElementById("createError").style.display = "block";
        }
      }
      
      async function approvePayment(paymentId) {
        if (!confirm('X√°c nh·∫≠n approve payment n√†y? API keys c·ªßa user s·∫Ω ƒë∆∞·ª£c extend 30 ng√†y.')) {
          return;
        }
        
        const adminKey = document.getElementById('adminKey').value.trim();
        if (!adminKey) {
          alert('Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n');
          return;
        }
        
        const row = document.getElementById('payment-row-' + paymentId);
        if (!row) return;
        
        const btn = row.querySelector('.btn-approve');
        const rejectBtn = row.querySelector('.btn-reject');
        const originalText = btn.textContent;
        btn.disabled = true;
        rejectBtn.disabled = true;
        btn.textContent = 'ƒêang x·ª≠ l√Ω...';
        
        try {
          const resp = await fetch(`/admin/payments/${paymentId}/approve`, {
            method: 'POST',
            headers: {
              'X-Admin-Key': adminKey
            }
          });
          
          if (resp.ok || resp.redirected) {
            // Remove row from table
            row.remove();
            // Show success message
            showMessage('‚úÖ ƒê√£ approve payment th√†nh c√¥ng!', 'success');
            // Reload payments if table is empty
            const tbody = row.closest('tbody');
            if (tbody && tbody.children.length === 0) {
              const adminKey = document.getElementById('adminKey').value.trim();
              loadPendingPayments(adminKey);
            }
          } else {
            const data = await resp.json();
            throw new Error(data.error || 'L·ªói khi approve payment');
          }
        } catch (error) {
          alert('L·ªói: ' + error.message);
          btn.disabled = false;
          rejectBtn.disabled = false;
          btn.textContent = originalText;
        }
      }
      
      async function rejectPayment(paymentId) {
        if (!confirm('X√°c nh·∫≠n reject payment n√†y? Payment s·∫Ω b·ªã h·ªßy v√† kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω.')) {
          return;
        }
        
        const adminKey = document.getElementById('adminKey').value.trim();
        if (!adminKey) {
          alert('Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n');
          return;
        }
        
        const row = document.getElementById('payment-row-' + paymentId);
        if (!row) return;
        
        const btn = row.querySelector('.btn-reject');
        const approveBtn = row.querySelector('.btn-approve');
        const originalText = btn.textContent;
        btn.disabled = true;
        approveBtn.disabled = true;
        btn.textContent = 'ƒêang x·ª≠ l√Ω...';
        
        try {
          const resp = await fetch(`/admin/payments/${paymentId}/reject`, {
            method: 'POST',
            headers: {
              'X-Admin-Key': adminKey
            }
          });
          
          if (resp.ok || resp.redirected) {
            // Remove row from table
            row.remove();
            // Show success message
            showMessage('‚úÖ ƒê√£ reject payment th√†nh c√¥ng!', 'success');
            // Reload payments if table is empty
            const tbody = row.closest('tbody');
            if (tbody && tbody.children.length === 0) {
              const adminKey = document.getElementById('adminKey').value.trim();
              loadPendingPayments(adminKey);
            }
          } else {
            const data = await resp.json();
            throw new Error(data.error || 'L·ªói khi reject payment');
          }
        } catch (error) {
          alert('L·ªói: ' + error.message);
          btn.disabled = false;
          approveBtn.disabled = false;
          btn.textContent = originalText;
        }
      }
      
      function showMessage(message, type) {
        const div = document.createElement('div');
        div.className = type === 'success' ? 'success' : 'error';
        div.textContent = message;
        div.style.marginTop = '16px';
        const paymentsSection = document.querySelector('.section:last-child');
        if (paymentsSection) {
          paymentsSection.insertBefore(div, paymentsSection.firstChild);
          setTimeout(() => div.remove(), 5000);
        }
      }
      
      let currentUsersPage = 1;
      let currentUserSearch = '';
      
      async function loadUsersList(page = 1) {
        const adminKey = document.getElementById('adminKey').value.trim();
        if (!adminKey) {
          document.getElementById('usersContainer').innerHTML = 
            '<p style="text-align: center; color: #d32f2f; padding: 40px;">Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n</p>';
          return;
        }
        
        const search = document.getElementById('userSearchInput').value.trim() || '';
        currentUsersPage = page;
        currentUserSearch = search;
        
        try {
          let url = `/admin/users?page=${page}&per_page=20`;
          if (search) {
            url += `&search=${encodeURIComponent(search)}`;
          }
          
          const resp = await fetch(url, {
            headers: { 'X-Admin-Key': adminKey }
          });
          
          if (!resp.ok) {
            if (resp.status === 403) {
              document.getElementById('usersContainer').innerHTML = 
                '<p style="text-align: center; color: #d32f2f; padding: 40px;">‚ùå Admin key kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.</p>';
            } else {
              const data = await resp.json();
              throw new Error(data.error || 'L·ªói khi t·∫£i danh s√°ch users');
            }
            return;
          }
          
          const data = await resp.json();
          const users = data.users || [];
          const pagination = data.pagination || {};
          
          if (users.length === 0) {
            document.getElementById('usersContainer').innerHTML = 
              '<p style="text-align: center; color: #666; padding: 40px;">Kh√¥ng t√¨m th·∫•y user n√†o</p>';
            return;
          }
          
          // Render users table
          const tierLabels = { free: 'Free', premium: 'Premium', ultra: 'Ultra' };
          let html = '<table class="payments-table"><thead><tr><th>ID</th><th>Email</th><th>T√™n</th><th>Tier hi·ªán t·∫°i</th><th>Status</th><th>Ng√†y t·∫°o</th><th>Thao t√°c</th></tr></thead><tbody>';
          
          users.forEach(user => {
            const currentTier = user.current_tier ? tierLabels[user.current_tier] || user.current_tier : 'Ch∆∞a c√≥';
            const dateStr = user.created_at ? new Date(user.created_at).toLocaleDateString('vi-VN') : 'N/A';
            
            // Escape quotes for JavaScript string
            const userEmailEscaped = (user.email || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const userTierEscaped = (user.current_tier || 'free').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            html += `
              <tr id="user-row-${user.id}">
                <td>${user.id}</td>
                <td class="user-email">${user.email}</td>
                <td>${user.full_name || 'N/A'}</td>
                <td><span class="badge badge-${user.current_tier || 'free'}">${currentTier}</span></td>
                <td>${user.status}</td>
                <td>${dateStr}</td>
                <td>
                  <button class="btn-approve" onclick="showChangeTierModal(${user.id}, '${userEmailEscaped}', '${userTierEscaped}')" style="margin-right: 8px;">
                    üîÑ ƒê·ªïi Tier
                  </button>
                  <button class="btn-reject" onclick="deleteUser(${user.id}, '${userEmailEscaped}')">
                    üóëÔ∏è X√≥a
                  </button>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          
          // Add pagination
          if (pagination.total_pages > 1) {
            html += '<div style="margin-top: 24px; text-align: center;">';
            
            // Previous button
            if (pagination.page > 1) {
              html += `<button onclick="loadUsersList(${pagination.page - 1})" style="margin-right: 8px;">‚Üê Tr∆∞·ªõc</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.page + 2);
            
            if (startPage > 1) {
              html += `<button onclick="loadUsersList(1)" style="margin-right: 4px;">1</button>`;
              if (startPage > 2) html += '<span style="margin: 0 4px;">...</span>';
            }
            
            for (let i = startPage; i <= endPage; i++) {
              if (i === pagination.page) {
                html += `<button style="background: #0b57d0; margin: 0 4px; font-weight: 600;">${i}</button>`;
              } else {
                html += `<button onclick="loadUsersList(${i})" style="margin: 0 4px;">${i}</button>`;
              }
            }
            
            if (endPage < pagination.total_pages) {
              if (endPage < pagination.total_pages - 1) html += '<span style="margin: 0 4px;">...</span>';
              html += `<button onclick="loadUsersList(${pagination.total_pages})" style="margin-left: 4px;">${pagination.total_pages}</button>`;
            }
            
            // Next button
            if (pagination.page < pagination.total_pages) {
              html += `<button onclick="loadUsersList(${pagination.page + 1})" style="margin-left: 8px;">Sau ‚Üí</button>`;
            }
            
            html += `<div style="margin-top: 8px; color: #666; font-size: 14px;">Trang ${pagination.page}/${pagination.total_pages} - T·ªïng: ${pagination.total} users</div>`;
            html += '</div>';
          }
          
          document.getElementById('usersContainer').innerHTML = html;
          
        } catch (error) {
          document.getElementById('usersContainer').innerHTML = 
            '<p style="text-align: center; color: #d32f2f; padding: 40px;">‚ùå L·ªói: ' + error.message + '</p>';
        }
      }
      
      function clearUserSearch() {
        document.getElementById('userSearchInput').value = '';
        loadUsersList(1);
      }
      
      async function deleteUser(userId, userEmail) {
        // Escape single quotes in email
        const displayEmail = userEmail.replace(/'/g, "\\'");
        
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a user n√†y?\n\nEmail: ${displayEmail}\nID: ${userId}\n\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
          return;
        }
        
        const adminKey = document.getElementById('adminKey').value.trim();
        if (!adminKey) {
          alert('Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n');
          return;
        }
        
        try {
          const resp = await fetch(`/admin/users/${userId}/delete`, {
            method: 'POST',
            headers: { 
              'X-Admin-Key': adminKey,
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          
          const data = await resp.json();
          
          if (resp.ok && data.success) {
            alert('‚úÖ ' + (data.message || 'ƒê√£ x√≥a user th√†nh c√¥ng!'));
            // Reload users list
            loadUsersList(currentUsersPage);
          } else {
            throw new Error(data.error || data.message || 'L·ªói khi x√≥a user');
          }
        } catch (error) {
          console.error('Error deleting user:', error);
          alert('L·ªói: ' + error.message);
        }
      }
      
      function showChangeTierModal(userId, userEmail, currentTier) {
        // Escape single quotes in email
        userEmail = userEmail.replace(/'/g, "\\'");
        
        const tierInput = prompt(`ƒê·ªïi tier cho user:\n${userEmail}\n\nTier hi·ªán t·∫°i: ${currentTier || 'Ch∆∞a c√≥'}\n\nNh·∫≠p tier m·ªõi (free/premium/ultra):`, currentTier || 'free');
        if (tierInput === null) return; // User cancelled
        
        const tier = tierInput.trim().toLowerCase();
        if (!tier) {
          alert('Tier kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
          return;
        }
        
        if (!['free', 'premium', 'ultra'].includes(tier)) {
          alert('Tier kh√¥ng h·ª£p l·ªá! Ph·∫£i l√†: free, premium, ho·∫∑c ultra');
          return;
        }
        
        const notesInput = prompt('Ghi ch√∫ (t√πy ch·ªçn, ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥):', '');
        const notes = notesInput ? notesInput.trim() : '';
        
        changeUserTierDirectly(userId, tier, notes);
      }
      
      async function changeUserTierDirectly(userId, targetTier, notes) {
        const adminKey = document.getElementById('adminKey').value.trim();
        if (!adminKey) {
          alert('Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n');
          return;
        }
        
        if (!confirm(`X√°c nh·∫≠n ƒë·ªïi tier user ID ${userId} sang ${targetTier.toUpperCase()}?`)) {
          return;
        }
        
        try {
          const formData = new FormData();
          formData.append('user_id', userId);
          formData.append('tier', targetTier);
          if (notes) formData.append('notes', notes);
          
          const resp = await fetch('/admin/users/change-tier', {
            method: 'POST',
            headers: { 
              'X-Admin-Key': adminKey,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });
          
          const data = await resp.json();
          
          if (resp.ok && data.success) {
            alert('‚úÖ ' + (data.message || 'ƒê√£ ƒë·ªïi tier th√†nh c√¥ng!'));
            // Reload users list
            loadUsersList(currentUsersPage);
          } else {
            throw new Error(data.error || data.message || 'L·ªói khi ƒë·ªïi tier');
          }
        } catch (error) {
          alert('L·ªói: ' + error.message);
        }
      }
      
      // Load users list when stats are loaded
      const originalLoadStats = loadStats;
      loadStats = function() {
        originalLoadStats();
        const adminKey = document.getElementById('adminKey').value.trim();
        if (adminKey) {
          setTimeout(() => loadUsersList(1), 500);
        }
      };
      
      let currentUserIdForTierChange = null;
      
      async function searchUserForTierChange() {
        const adminKey = document.getElementById('adminKey').value.trim();
        const email = document.getElementById('changeTierEmail').value.trim();
        
        if (!adminKey) {
          document.getElementById('changeTierError').textContent = 'Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n';
          document.getElementById('changeTierError').style.display = 'block';
          return;
        }
        
        if (!email) {
          document.getElementById('changeTierError').textContent = 'Vui l√≤ng nh·∫≠p email user';
          document.getElementById('changeTierError').style.display = 'block';
          return;
        }
        
        document.getElementById('changeTierError').style.display = 'none';
        document.getElementById('changeTierSuccess').style.display = 'none';
        document.getElementById('changeTierUserInfo').style.display = 'none';
        document.getElementById('changeTierBtn').style.display = 'none';
        
        try {
          const resp = await fetch(`/admin/users/search?email=${encodeURIComponent(email)}`, {
            headers: { 'X-Admin-Key': adminKey }
          });
          
          if (!resp.ok) {
            const data = await resp.json();
            throw new Error(data.error || 'Kh√¥ng t√¨m th·∫•y user');
          }
          
          const data = await resp.json();
          const user = data.user;
          currentUserIdForTierChange = user.id;
          
          // Display user info
          const tierLabels = { free: 'Free', premium: 'Premium', ultra: 'Ultra' };
          const currentTier = user.current_tier ? tierLabels[user.current_tier] || user.current_tier : 'Ch∆∞a c√≥';
          
          document.getElementById('changeTierUserDetails').innerHTML = `
            <p><strong>ID:</strong> ${user.id}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>T√™n:</strong> ${user.full_name || 'N/A'}</p>
            <p><strong>Tier hi·ªán t·∫°i:</strong> <span class="badge badge-${user.current_tier || 'free'}">${currentTier}</span></p>
            <p><strong>Status:</strong> ${user.status}</p>
          `;
          
          document.getElementById('changeTierUserInfo').style.display = 'block';
          document.getElementById('changeTierBtn').style.display = 'inline-block';
          
        } catch (error) {
          document.getElementById('changeTierError').textContent = 'L·ªói: ' + error.message;
          document.getElementById('changeTierError').style.display = 'block';
        }
      }
      
      async function changeUserTier() {
        if (!currentUserIdForTierChange) {
          alert('Vui l√≤ng t√¨m user tr∆∞·ªõc');
          return;
        }
        
        const adminKey = document.getElementById('adminKey').value.trim();
        const targetTier = document.getElementById('changeTierSelect').value;
        const notes = document.getElementById('changeTierNotes').value.trim();
        
        if (!adminKey) {
          alert('Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n');
          return;
        }
        
        if (!confirm(`X√°c nh·∫≠n ƒë·ªïi tier user ID ${currentUserIdForTierChange} sang ${targetTier.toUpperCase()}?`)) {
          return;
        }
        
        const btn = document.getElementById('changeTierBtn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'ƒêang x·ª≠ l√Ω...';
        
        try {
          const formData = new FormData();
          formData.append('user_id', currentUserIdForTierChange);
          formData.append('tier', targetTier);
          if (notes) formData.append('notes', notes);
          
          const resp = await fetch('/admin/users/change-tier', {
            method: 'POST',
            headers: { 'X-Admin-Key': adminKey },
            body: formData
          });
          
          if (resp.ok || resp.redirected) {
            document.getElementById('changeTierSuccess').textContent = '‚úÖ ƒê√£ ƒë·ªïi tier th√†nh c√¥ng!';
            document.getElementById('changeTierSuccess').style.display = 'block';
            document.getElementById('changeTierError').style.display = 'none';
            
            // Reset form
            document.getElementById('changeTierEmail').value = '';
            document.getElementById('changeTierNotes').value = '';
            document.getElementById('changeTierUserInfo').style.display = 'none';
            document.getElementById('changeTierBtn').style.display = 'none';
            currentUserIdForTierChange = null;
            
            // Reload after 2 seconds
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            const text = await resp.text();
            throw new Error('L·ªói khi ƒë·ªïi tier');
          }
        } catch (error) {
          document.getElementById('changeTierError').textContent = 'L·ªói: ' + error.message;
          document.getElementById('changeTierError').style.display = 'block';
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
    </script>
  </body>
</html>

