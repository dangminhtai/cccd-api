<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - CCCD API</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: #f5f5f5; }
      .container { max-width: 1200px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      h1 { margin-top: 0; color: #333; }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin: 24px 0; }
      .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #0b57d0; }
      .stat-card h3 { margin: 0 0 8px; font-size: 14px; color: #666; text-transform: uppercase; }
      .stat-card .value { font-size: 32px; font-weight: 600; color: #333; }
      .tier-stats { margin-top: 24px; }
      .tier-stats table { width: 100%; border-collapse: collapse; }
      .tier-stats th, .tier-stats td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
      .tier-stats th { background: #f8f9fa; font-weight: 600; }
      .tier-stats tr:hover { background: #f8f9fa; }
      .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
      .badge-free { background: #e3f2fd; color: #1976d2; }
      .badge-premium { background: #fff3e0; color: #f57c00; }
      .badge-ultra { background: #f3e5f5; color: #7b1fa2; }
      .error { color: #d32f2f; background: #ffebee; padding: 12px; border-radius: 8px; margin: 16px 0; }
      .loading { text-align: center; padding: 40px; color: #666; }
      button { padding: 10px 16px; border: 0; border-radius: 8px; background: #0b57d0; color: white; cursor: pointer; font-size: 14px; }
      button:hover { background: #0a4fb8; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; min-width: 300px; }
      .form-group { margin: 16px 0; }
      label { display: block; margin-bottom: 6px; font-size: 14px; color: #555; }
      .form-row { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
      .form-row > div { flex: 1; min-width: 200px; }
      .success { color: #2e7d32; background: #e8f5e9; padding: 12px; border-radius: 8px; margin: 16px 0; }
      .key-display { background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace; word-break: break-all; }
      .key-display strong { color: #d32f2f; }
      .section { margin-top: 32px; padding-top: 24px; border-top: 2px solid #e0e0e0; }
      .section h2 { margin-top: 0; }
      .payments-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .payments-table th, .payments-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
      .payments-table th { background: #f8f9fa; font-weight: 600; }
      .payments-table tr:hover { background: #f8f9fa; }
      .btn-approve { padding: 6px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
      .btn-approve:hover { background: #218838; }
      .amount { font-weight: 600; color: #28a745; }
      .user-info { color: #495057; }
      .user-email { color: #0b57d0; font-weight: 500; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Admin Dashboard</h1>

      <div class="form-group">
        <label>Admin Secret Key</label>
        <input id="adminKey" type="password" placeholder="Nh·∫≠p ADMIN_SECRET t·ª´ .env" />
        <button onclick="loadStats()">T·∫£i th·ªëng k√™</button>
      </div>

      <div id="error" class="error" style="display:none;"></div>
      <div id="loading" class="loading" style="display:none;">ƒêang t·∫£i...</div>

      <div id="stats" style="display:none;">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Requests h√¥m nay</h3>
            <div class="value" id="requestsToday">0</div>
          </div>
        </div>

        <div class="tier-stats">
          <h2>T·ªïng quan theo Tier</h2>
          <table>
            <thead>
              <tr>
                <th>Tier</th>
                <th>T·ªïng Keys</th>
                <th>Keys ƒëang ho·∫°t ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="tierTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h2>üîë T·∫°o API Key m·ªõi</h2>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label>Tier</label>
              <select id="createTier">
                <option value="free">Free (10 req/ph√∫t)</option>
                <option value="premium">Premium (100 req/ph√∫t)</option>
                <option value="ultra">Ultra (1000 req/ph√∫t)</option>
              </select>
            </div>
            <div>
              <label>Email ch·ªß s·ªü h·ªØu</label>
              <input id="createEmail" type="email" placeholder="customer@example.com" />
            </div>
            <div>
              <label>S·ªë ng√†y h·ª£p l·ªá (ƒë·ªÉ tr·ªëng = vƒ©nh vi·ªÖn)</label>
              <input id="createDays" type="number" placeholder="30" min="1" step="1" pattern="[0-9]+" />
            </div>
          </div>
          <button onclick="createKey()">T·∫°o Key</button>
        </div>

        <div id="createError" class="error" style="display:none;"></div>
        <div id="createSuccess" class="success" style="display:none;">
          <strong>‚ö†Ô∏è L∆ØU √ù: Key ch·ªâ hi·ªÉn th·ªã 1 l·∫ßn n√†y. H√£y copy v√† l∆∞u ngay!</strong>
          <div class="key-display" id="createdKey"></div>
        </div>
      </div>
      
      <!-- Pending Payments Section -->
      <div class="section">
        <h2>üí∞ Pending Payments - Ch·ªù X√°c Nh·∫≠n</h2>
        <div id="paymentsContainer">
          <p style="text-align: center; color: #666; padding: 40px;">
            Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n v√† nh·∫•n "T·∫£i th·ªëng k√™" ƒë·ªÉ xem pending payments
          </p>
        </div>
      </div>
    </div>

    <script>
      function showError(msg) {
        document.getElementById("error").textContent = msg;
        document.getElementById("error").style.display = "block";
        document.getElementById("stats").style.display = "none";
      }

      function hideError() {
        document.getElementById("error").style.display = "none";
      }

      async function loadStats() {
        const adminKey = document.getElementById("adminKey").value.trim();
        if (!adminKey) {
          showError("Vui l√≤ng nh·∫≠p Admin Secret Key");
          return;
        }

        document.getElementById("loading").style.display = "block";
        document.getElementById("stats").style.display = "none";
        hideError();

        try {
          const resp = await fetch("/admin/stats", {
            headers: { "X-Admin-Key": adminKey }
          });

          if (!resp.ok) {
            const data = await resp.json();
            throw new Error(data.error || `HTTP ${resp.status}`);
          }

          const data = await resp.json();

          // Update requests today
          document.getElementById("requestsToday").textContent = data.requests_today || 0;

          // Update tier stats
          const tbody = document.getElementById("tierTableBody");
          tbody.innerHTML = "";

          const tiers = data.tiers || {};
          const tierOrder = ["free", "premium", "ultra"];
          const tierLabels = { free: "Free", premium: "Premium", ultra: "Ultra" };

          tierOrder.forEach(tier => {
            if (tiers[tier]) {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td><span class="badge badge-${tier}">${tierLabels[tier]}</span></td>
                <td>${tiers[tier].total || 0}</td>
                <td>${tiers[tier].active || 0}</td>
              `;
              tbody.appendChild(row);
            }
          });

          document.getElementById("loading").style.display = "none";
          document.getElementById("stats").style.display = "block";
          
          // Load pending payments sau khi load stats th√†nh c√¥ng
          loadPendingPayments(adminKey);
        } catch (e) {
          document.getElementById("loading").style.display = "none";
          showError("L·ªói: " + e.message);
        }
      }
      
      async function loadPendingPayments(adminKey) {
        if (!adminKey) {
          return;
        }
        
        try {
          const resp = await fetch("/admin/payments", {
            headers: { "X-Admin-Key": adminKey }
          });
          
          if (!resp.ok) {
            if (resp.status === 403) {
              document.getElementById("paymentsContainer").innerHTML = 
                '<p style="text-align: center; color: #d32f2f; padding: 40px;">‚ùå Admin key kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.</p>';
            } else {
              throw new Error(`HTTP ${resp.status}`);
            }
            return;
          }
          
          const data = await resp.json();
          const payments = data.payments || [];
          
          if (payments.length === 0) {
            document.getElementById("paymentsContainer").innerHTML = 
              '<p style="text-align: center; color: #666; padding: 40px;">Kh√¥ng c√≥ payment n√†o ƒëang ch·ªù x·ª≠ l√Ω</p>';
            return;
          }
          
          // Render payments table
          let html = '<table class="payments-table"><thead><tr><th>Ng√†y</th><th>Kh√°ch h√†ng</th><th>S·ªë ti·ªÅn</th><th>Ph∆∞∆°ng th·ª©c</th><th>Ghi ch√∫</th><th>Thao t√°c</th></tr></thead><tbody>';
          
          payments.forEach(payment => {
            const dateStr = payment.created_at ? new Date(payment.created_at).toLocaleString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : 'N/A';
            
            const amountStr = payment.currency === 'VND' 
              ? new Intl.NumberFormat('vi-VN').format(payment.amount) + ' ' + payment.currency
              : '$' + payment.amount.toFixed(2) + ' ' + payment.currency;
            
            html += `
              <tr id="payment-row-${payment.id}">
                <td>${dateStr}</td>
                <td class="user-info">
                  <div class="user-email">${payment.user_email || 'N/A'}</div>
                  <div style="font-size: 12px; color: #666;">${payment.user_name || 'N/A'}</div>
                </td>
                <td class="amount">${amountStr}</td>
                <td>${payment.payment_gateway || 'N/A'}</td>
                <td>${payment.notes || '-'}</td>
                <td>
                  <button class="btn-approve" onclick="approvePayment(${payment.id})">
                    ‚úÖ Approve
                  </button>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          document.getElementById("paymentsContainer").innerHTML = html;
        } catch (e) {
          document.getElementById("paymentsContainer").innerHTML = 
            '<p style="text-align: center; color: #d32f2f; padding: 40px;">‚ùå L·ªói khi t·∫£i pending payments: ' + e.message + '</p>';
        }
      }

      // Enter key to load
      document.getElementById("adminKey").addEventListener("keypress", (e) => {
        if (e.key === "Enter") loadStats();
      });

      // Ch·ªâ cho ph√©p nh·∫≠p s·ªë 0-9 v√†o √¥ "S·ªë ng√†y"
      document.getElementById("createDays").addEventListener("keypress", (e) => {
        // Cho ph√©p: s·ªë 0-9, Backspace, Delete, Arrow keys, Tab
        const allowed = /[0-9]|Backspace|Delete|ArrowLeft|ArrowRight|Tab/;
        if (!allowed.test(e.key)) {
          e.preventDefault();
        }
      });

      // NgƒÉn paste text kh√¥ng ph·∫£i s·ªë
      document.getElementById("createDays").addEventListener("paste", (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData("text");
        const numbersOnly = paste.replace(/[^0-9]/g, "");
        if (numbersOnly) {
          e.target.value = numbersOnly;
        }
      });

      async function createKey() {
        const adminKey = document.getElementById("adminKey").value.trim();
        const tier = document.getElementById("createTier").value;
        const email = document.getElementById("createEmail").value.trim();
        const days = document.getElementById("createDays").value.trim();

        if (!adminKey) {
          showError("Vui l√≤ng nh·∫≠p Admin Secret Key tr∆∞·ªõc");
          return;
        }

        if (!email) {
          document.getElementById("createError").textContent = "Vui l√≤ng nh·∫≠p email";
          document.getElementById("createError").style.display = "block";
          document.getElementById("createSuccess").style.display = "none";
          return;
        }

        document.getElementById("createError").style.display = "none";
        document.getElementById("createSuccess").style.display = "none";

        try {
          const body = { tier, email };
          if (days) {
            const daysNum = parseInt(days);
            if (isNaN(daysNum) || daysNum < 1) {
              document.getElementById("createError").textContent = "S·ªë ng√†y ph·∫£i l√† s·ªë nguy√™n >= 1";
              document.getElementById("createError").style.display = "block";
              return;
            }
            body.days = daysNum;
          }

          const resp = await fetch("/admin/keys/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Key": adminKey
            },
            body: JSON.stringify(body)
          });

          if (!resp.ok) {
            const data = await resp.json();
            throw new Error(data.error || `HTTP ${resp.status}`);
          }

          const data = await resp.json();
          
          // Hi·ªÉn th·ªã key
          document.getElementById("createdKey").textContent = data.api_key;
          document.getElementById("createSuccess").style.display = "block";
          
          // Reset form
          document.getElementById("createEmail").value = "";
          document.getElementById("createDays").value = "";
          
          // Reload stats ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng keys
          loadStats();
        } catch (e) {
          document.getElementById("createError").textContent = "L·ªói: " + e.message;
          document.getElementById("createError").style.display = "block";
        }
      }
      
      async function approvePayment(paymentId) {
        if (!confirm('X√°c nh·∫≠n approve payment n√†y? API keys c·ªßa user s·∫Ω ƒë∆∞·ª£c extend 30 ng√†y.')) {
          return;
        }
        
        const adminKey = document.getElementById('adminKey').value.trim();
        if (!adminKey) {
          alert('Vui l√≤ng nh·∫≠p Admin Secret Key ·ªü tr√™n');
          return;
        }
        
        const btn = event.target;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'ƒêang x·ª≠ l√Ω...';
        
        try {
          const resp = await fetch(`/admin/payments/${paymentId}/approve`, {
            method: 'POST',
            headers: {
              'X-Admin-Key': adminKey
            }
          });
          
          if (resp.ok || resp.redirected) {
            // Remove row from table
            const row = document.getElementById('payment-row-' + paymentId);
            if (row) {
              row.remove();
            }
            // Show success message
            showMessage('‚úÖ ƒê√£ approve payment th√†nh c√¥ng!', 'success');
          } else {
            const data = await resp.json();
            throw new Error(data.error || 'L·ªói khi approve payment');
          }
        } catch (error) {
          alert('L·ªói: ' + error.message);
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
      
      function showMessage(message, type) {
        const div = document.createElement('div');
        div.className = type === 'success' ? 'success' : 'error';
        div.textContent = message;
        div.style.marginTop = '16px';
        const paymentsSection = document.querySelector('.section:last-child');
        if (paymentsSection) {
          paymentsSection.insertBefore(div, paymentsSection.firstChild);
          setTimeout(() => div.remove(), 5000);
        }
      }
    </script>
  </body>
</html>

