<!DOCTYPE html>
<html class="dark" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Usage Statistics - CCCD API</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Tailwind Config -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#427cf0",
                        "background-light": "#f6f6f8",
                        "background-dark": "#0f172a",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    boxShadow: {
                        'neon-blue': '0 0 10px rgba(66, 124, 240, 0.5), 0 0 20px rgba(66, 124, 240, 0.3)',
                        'neon-green': '0 0 10px rgba(16, 185, 129, 0.5), 0 0 20px rgba(16, 185, 129, 0.3)',
                        'neon-red': '0 0 10px rgba(239, 68, 68, 0.5), 0 0 20px rgba(239, 68, 68, 0.3)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                    }
                },
            },
        }
    </script>
    
    <style>
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .bg-grid-pattern {
            background-image: linear-gradient(to right, #1e293b 1px, transparent 1px),
                              linear-gradient(to bottom, #1e293b 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* Material Symbols */
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
    </style>
</head>
<body class="bg-background-dark text-white font-display antialiased overflow-x-hidden selection:bg-primary selection:text-white">
    <!-- Background Grid Effect -->
    <div class="fixed inset-0 pointer-events-none opacity-[0.15] bg-grid-pattern z-0"></div>
    <div class="relative z-10 flex min-h-screen w-full flex-col">
        <!-- Top Navigation -->
        <header class="glass-panel sticky top-0 z-50 w-full border-b border-white/10">
            <div class="flex h-16 items-center justify-between px-6 lg:px-8">
                <div class="flex items-center gap-4">
                    <a href="{{ url_for('portal.dashboard') }}" class="flex items-center gap-4">
                        <div class="flex items-center justify-center size-8 rounded bg-primary/20 text-primary">
                            <span class="material-symbols-outlined">api</span>
                        </div>
                        <h1 class="text-xl font-bold tracking-tight">CCCD API Portal</h1>
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <a href="{{ url_for('portal.dashboard') }}" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-colors">
                        <span class="material-symbols-outlined text-[20px]">dashboard</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="{{ url_for('portal.keys') }}" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-colors">
                        <span class="material-symbols-outlined text-[20px]">vpn_key</span>
                        <span>Keys</span>
                    </a>
                    <div class="h-8 w-[1px] bg-white/10 mx-1"></div>
                    <span class="text-sm font-medium text-slate-400">
                        Xin chào, <span class="font-bold text-white">{{ user.full_name }}</span>
                    </span>
                    <a href="{{ url_for('portal.logout') }}" class="flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-bold text-white hover:bg-blue-600 transition-colors shadow-neon-blue">
                        <span class="truncate">Đăng xuất</span>
                    </a>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-8 max-w-[1600px] mx-auto w-full space-y-8">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="fixed top-24 right-6 z-[10000] space-y-3">
                        {% for category, message in messages %}
                            <div class="glass-panel p-4 rounded-lg {% if category == 'success' %}border border-emerald-500/30 text-emerald-400{% elif category == 'error' %}border border-red-500/30 text-red-400{% elif category == 'warning' %}border border-yellow-500/30 text-yellow-400{% else %}border border-primary/30 text-white{% endif %}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            
            <!-- Page Header & Controls -->
            <div class="flex flex-col gap-6 md:flex-row md:items-end md:justify-between">
                <div>
                    <div class="flex items-center gap-2 text-slate-400 text-sm mb-1">
                        <a href="{{ url_for('portal.dashboard') }}" class="hover:text-white">Dashboard</a>
                        <span class="material-symbols-outlined text-[14px]">chevron_right</span>
                        <span class="text-white">Analytics</span>
                    </div>
                    <h2 class="text-4xl font-black tracking-tight text-white drop-shadow-lg">Usage Statistics</h2>
                    <p class="text-slate-400 mt-2 text-lg">Real-time monitoring of API traffic and performance metrics.</p>
                </div>
                <!-- Time Range Filter -->
                <div class="glass-panel p-1 rounded-xl flex items-center">
                    <a href="{{ url_for('portal.usage', days=1) }}" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 1 %}bg-primary text-white shadow-sm{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %} transition-colors">24h</a>
                    <a href="{{ url_for('portal.usage', days=7) }}" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 7 %}bg-primary text-white shadow-sm{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %} transition-colors">7 Days</a>
                    <a href="{{ url_for('portal.usage', days=30) }}" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 30 %}bg-primary text-white shadow-sm{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %} transition-colors">30 Days</a>
                    <a href="{{ url_for('portal.usage', days=90) }}" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 90 %}bg-primary text-white shadow-sm{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %} transition-colors">90 Days</a>
                    <div class="w-[1px] h-6 bg-white/10 mx-1"></div>
                    <a href="{{ url_for('portal.usage', days=365) }}" class="px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">calendar_today</span>
                        <span>Custom</span>
                    </a>
                </div>
            </div>
            
            <!-- Stats Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Requests -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 size-24 rounded-full bg-primary/10 blur-xl group-hover:bg-primary/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-slate-800 rounded-lg text-primary border border-slate-700">
                            <span class="material-symbols-outlined">show_chart</span>
                        </div>
                    </div>
                    <p class="text-slate-400 text-sm font-medium">Total Requests</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ "{:,}".format(stats.total_requests) }}</p>
                </div>
                
                <!-- Success Rate -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group border-emerald-500/30">
                    <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/5 to-transparent pointer-events-none"></div>
                    <div class="absolute -right-6 -top-6 size-24 rounded-full bg-emerald-500/10 blur-xl group-hover:bg-emerald-500/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-slate-800 rounded-lg text-emerald-400 border border-slate-700 shadow-[0_0_15px_rgba(16,185,129,0.15)]">
                            <span class="material-symbols-outlined">check_circle</span>
                        </div>
                    </div>
                    <p class="text-slate-400 text-sm font-medium">Success Rate</p>
                    {% set success_rate = (stats.success_requests / stats.total_requests * 100) if stats.total_requests > 0 else 0 %}
                    <p class="text-3xl font-bold text-white mt-1 drop-shadow-[0_0_8px_rgba(16,185,129,0.5)]">{{ "%.1f"|format(success_rate) }}%</p>
                </div>
                
                <!-- Error Rate -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group border-red-500/30">
                    <div class="absolute inset-0 bg-gradient-to-br from-red-500/5 to-transparent pointer-events-none"></div>
                    <div class="absolute -right-6 -top-6 size-24 rounded-full bg-red-500/10 blur-xl group-hover:bg-red-500/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-slate-800 rounded-lg text-red-400 border border-slate-700 shadow-[0_0_15px_rgba(239,68,68,0.15)]">
                            <span class="material-symbols-outlined">warning</span>
                        </div>
                    </div>
                    <p class="text-slate-400 text-sm font-medium">Error Rate</p>
                    {% set error_rate = (stats.error_requests / stats.total_requests * 100) if stats.total_requests > 0 else 0 %}
                    <p class="text-3xl font-bold text-white mt-1 drop-shadow-[0_0_8px_rgba(239,68,68,0.5)]">{{ "%.1f"|format(error_rate) }}%</p>
                </div>
                
                <!-- Avg Latency -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group border-primary/30">
                    <div class="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent pointer-events-none"></div>
                    <div class="absolute -right-6 -top-6 size-24 rounded-full bg-primary/10 blur-xl group-hover:bg-primary/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-slate-800 rounded-lg text-primary border border-slate-700 shadow-[0_0_15px_rgba(66,124,240,0.15)]">
                            <span class="material-symbols-outlined">timer</span>
                        </div>
                    </div>
                    <p class="text-slate-400 text-sm font-medium">Avg Latency</p>
                    <p class="text-3xl font-bold text-white mt-1 drop-shadow-[0_0_8px_rgba(66,124,240,0.5)]">{{ "%.0f"|format(stats.avg_response_time_ms) }}ms</p>
                </div>
            </div>
            
            <!-- Main Chart Area -->
            <div class="glass-panel rounded-xl p-6 border-t-2 border-t-primary/50 relative">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-white">Aggregate Traffic Overview</h3>
                        <p class="text-slate-400 text-sm">Requests vs Errors over time</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2">
                            <span class="size-3 rounded-full bg-primary shadow-[0_0_8px_rgba(66,124,240,0.8)]"></span>
                            <span class="text-sm text-slate-300">Requests</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="size-3 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></span>
                            <span class="text-sm text-slate-300">Success</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="size-3 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]"></span>
                            <span class="text-sm text-slate-300">Errors</span>
                        </div>
                    </div>
                </div>
                <!-- Chart Visual -->
                <div class="relative h-[300px] w-full">
                    <canvas id="aggregateChart"></canvas>
                </div>
            </div>
            
            <!-- Master-Detail View (Leaderboard) -->
            {% if stats_by_key %}
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 h-[600px]">
                <!-- Left: Leaderboard List -->
                <div class="xl:col-span-7 flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <!-- Search & Filters -->
                    <div class="p-4 border-b border-slate-700/50 flex gap-4">
                        <div class="relative flex-1">
                            <span class="material-symbols-outlined absolute left-3 top-2.5 text-slate-400">search</span>
                            <input id="key-search" class="w-full bg-slate-900/50 border border-slate-700 text-white rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none placeholder:text-slate-500 font-mono text-sm" placeholder="Search by Key Prefix or Label..." type="text"/>
                        </div>
                        <button class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-700 transition-colors">
                            <span class="material-symbols-outlined text-[18px]">filter_list</span>
                            <span class="text-sm font-medium">Filter</span>
                        </button>
                    </div>
                    <!-- Table Header -->
                    <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-slate-800/50 text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-700/50">
                        <div class="col-span-4">API Key / Label</div>
                        <div class="col-span-3">Traffic Trend</div>
                        <div class="col-span-2 text-right">Volume</div>
                        <div class="col-span-2 text-right">Success</div>
                        <div class="col-span-1"></div>
                    </div>
                    <!-- Scrollable List -->
                    <div id="key-list" class="overflow-y-auto flex-1 p-2 space-y-1">
                        {% for key_stat in stats_by_key %}
                        <div class="key-item grid grid-cols-12 gap-4 items-center px-4 py-3 rounded-lg hover:bg-slate-800/50 cursor-pointer border border-transparent hover:border-slate-700 transition-all group" 
                             data-key-id="{{ key_stat.key_id }}"
                             data-key-prefix="{{ key_stat.key_prefix }}"
                             data-key-label="{{ key_stat.label or '' }}"
                             data-key-tier="{{ key_stat.tier }}">
                            <script type="application/json" class="key-data-json">{{ key_stat|tojson|safe }}</script>
                            <div class="col-span-4 flex items-center gap-3">
                                <div class="size-8 rounded {% if key_stat.tier == 'ultra' %}bg-purple-500/20 text-purple-400{% elif key_stat.tier == 'premium' %}bg-amber-500/20 text-amber-400{% else %}bg-slate-500/20 text-slate-400{% endif %} flex items-center justify-center font-bold text-xs">
                                    {{ (key_stat.label or key_stat.key_prefix)[0]|upper }}
                                </div>
                                <div>
                                    <p class="font-bold text-white text-sm">{{ key_stat.label or '(Không có label)' }}</p>
                                    <p class="font-mono text-xs text-slate-400">{{ key_stat.key_prefix }}...</p>
                                </div>
                            </div>
                            <div class="col-span-3 h-8 flex items-center">
                                <!-- Mini Sparkline -->
                                <svg class="w-full h-full sparkline" data-key-id="{{ key_stat.key_id }}" preserveAspectRatio="none" viewBox="0 0 100 30">
                                    <path class="sparkline-path" fill="none" stroke="{% if key_stat.tier == 'ultra' %}#a855f7{% elif key_stat.tier == 'premium' %}#f59e0b{% else %}#64748b{% endif %}" stroke-width="2"></path>
                                </svg>
                            </div>
                            <div class="col-span-2 text-right">
                                <p class="text-sm font-bold text-white">{{ "{:,}".format(key_stat.total_requests) }}</p>
                                <div class="w-full bg-slate-700 h-1 mt-1 rounded-full overflow-hidden">
                                    {% set max_requests = stats_by_key|map(attribute='total_requests')|max %}
                                    {% set percentage = (key_stat.total_requests / max_requests * 100) if max_requests > 0 else 0 %}
                                    <div class="{% if key_stat.tier == 'ultra' %}bg-purple-500{% elif key_stat.tier == 'premium' %}bg-amber-500{% else %}bg-slate-400{% endif %} h-full progress-bar" data-percentage="{{ percentage }}"></div>
                                </div>
                            </div>
                            <div class="col-span-2 text-right">
                                {% set success_rate = (key_stat.success_requests / key_stat.total_requests * 100) if key_stat.total_requests > 0 else 0 %}
                                <span class="text-sm font-medium {% if success_rate >= 99 %}text-emerald-400{% elif success_rate >= 95 %}text-yellow-400{% else %}text-red-400{% endif %}">{{ "%.1f"|format(success_rate) }}%</span>
                            </div>
                            <div class="col-span-1 flex justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="p-3 border-t border-slate-700/50 bg-slate-800/30 text-center text-xs text-slate-500 hover:text-white cursor-pointer transition-colors">
                        View All {{ stats_by_key|length }} Keys
                    </div>
                </div>
                
                <!-- Right: Details Panel (Sticky) -->
                <div class="xl:col-span-5 h-full">
                    <div id="key-detail-panel" class="glass-panel h-full rounded-xl p-6 border-l-4 border-l-primary flex flex-col">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span id="detail-tier-badge" class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30 uppercase">Active</span>
                                </div>
                                <h3 id="detail-key-name" class="text-2xl font-bold text-white">Chọn một API Key</h3>
                                <p id="detail-key-prefix" class="font-mono text-sm text-slate-400 mt-1">-</p>
                            </div>
                            <button class="size-8 rounded-full bg-slate-800 flex items-center justify-center hover:bg-slate-700 text-slate-400 transition-colors">
                                <span class="material-symbols-outlined text-[18px]">more_vert</span>
                            </button>
                        </div>
                        <!-- Key Specific Stats -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-400 mb-1">Total Calls</p>
                                <p id="detail-total" class="text-xl font-bold text-white">-</p>
                            </div>
                            <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-400 mb-1">Avg Latency</p>
                                <p id="detail-latency" class="text-xl font-bold text-white">-</p>
                            </div>
                            <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-400 mb-1">Success</p>
                                <p id="detail-success" class="text-xl font-bold text-emerald-400">-</p>
                            </div>
                            <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-400 mb-1">Errors</p>
                                <p id="detail-errors" class="text-xl font-bold text-red-400">-</p>
                            </div>
                        </div>
                        <!-- Visualization Area in Panel -->
                        <div class="flex-1 min-h-[150px] relative bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                            <p class="text-sm font-bold text-white mb-4">Requests theo ngày</p>
                            <div class="chart-container" style="height: 200px;">
                                <canvas id="keyDetailChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </main>
    </div>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="application/json" id="daily-stats-data">{{ stats.daily_stats|tojson|safe }}</script>
    <script type="application/json" id="stats-by-key-data">{{ stats_by_key|tojson|safe }}</script>
    <script>
        // Parse data with error handling
        var dailyData = [];
        var statsByKey = [];
        
        try {
            var dailyDataEl = document.getElementById('daily-stats-data');
            if (dailyDataEl) {
                dailyData = JSON.parse(dailyDataEl.textContent) || [];
            }
        } catch(e) {
            console.error('Error parsing daily stats:', e);
        }
        
        try {
            var statsByKeyEl = document.getElementById('stats-by-key-data');
            if (statsByKeyEl) {
                statsByKey = JSON.parse(statsByKeyEl.textContent) || [];
            }
        } catch(e) {
            console.error('Error parsing stats by key:', e);
        }
        
        var keyDetailChart = null;
        var selectedKeyId = null;
        
        // Wait for Chart.js to load
        function initCharts() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                return;
            }
            
            // Aggregate Chart
            var aggregateCanvas = document.getElementById('aggregateChart');
            if (aggregateCanvas && dailyData && dailyData.length > 0) {
                var ctx = aggregateCanvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dailyData.map(function(d) { return d.date; }).reverse(),
                        datasets: [
                            {
                                label: 'Requests',
                                data: dailyData.map(function(d) { return d.count || 0; }).reverse(),
                                borderColor: '#427cf0',
                                backgroundColor: 'rgba(66, 124, 240, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Success',
                                data: dailyData.map(function(d) { return d.success || 0; }).reverse(),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                borderDash: [4, 2]
                            },
                            {
                                label: 'Errors',
                                data: dailyData.map(function(d) { return d.error || 0; }).reverse(),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            }
                        }
                    }
                });
            } else if (aggregateCanvas) {
                // Show message if no data
                var ctx = aggregateCanvas.getContext('2d');
                ctx.font = '16px Space Grotesk';
                ctx.fillStyle = '#94a3b8';
                ctx.textAlign = 'center';
                ctx.fillText('Chưa có dữ liệu', aggregateCanvas.width / 2, aggregateCanvas.height / 2);
            }
        }
        
        // Draw sparklines
        function drawSparklines() {
            if (!statsByKey || statsByKey.length === 0) return;
            
            document.querySelectorAll('.sparkline').forEach(function(svg) {
                try {
                    // Get key_id from data attribute
                    var keyId = parseInt(svg.getAttribute('data-key-id'));
                    if (!keyId) return;
                    
                    // Find key data from statsByKey array
                    var keyStat = statsByKey.find(function(k) { return k.key_id === keyId; });
                    if (!keyStat) return;
                    
                    var daily = keyStat.daily_stats || [];
                    if (!daily || daily.length < 2) {
                        // Draw flat line if no data
                        var path = svg.querySelector('.sparkline-path');
                        if (path) {
                            path.setAttribute('d', 'M0,15 L100,15');
                        }
                        return;
                    }
                    
                    var path = svg.querySelector('.sparkline-path');
                    if (!path) return;
                    
                    var counts = daily.map(function(d) { return d.count || 0; });
                    var max = Math.max.apply(null, counts);
                    if (max === 0) max = 1; // Avoid division by zero
                    
                    var points = daily.map(function(d, i) {
                        var x = daily.length > 1 ? (i * 100) / (daily.length - 1) : 50;
                        var y = 30 - ((d.count || 0) / max * 25);
                        return x + ',' + y;
                    });
                    
                    path.setAttribute('d', 'M' + points.join(' L'));
                } catch(e) {
                    console.error('Error drawing sparkline:', e);
                }
            });
        }
        
        // Set progress bars
        document.querySelectorAll('.progress-bar').forEach(function(bar) {
            bar.style.width = (parseFloat(bar.dataset.percentage) || 0) + '%';
        });
        
        // Update detail panel
        function updateDetailPanel(keyStat) {
            document.getElementById('detail-key-name').textContent = keyStat.label || '(Không có label)';
            document.getElementById('detail-key-prefix').textContent = keyStat.key_prefix + '...';
            
            var tierBadge = document.getElementById('detail-tier-badge');
            if (keyStat.tier === 'ultra') {
                tierBadge.className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-purple-500/20 text-purple-400 border border-purple-500/30 uppercase';
                tierBadge.textContent = 'Ultra';
            } else if (keyStat.tier === 'premium') {
                tierBadge.className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-amber-500/20 text-amber-400 border border-amber-500/30 uppercase';
                tierBadge.textContent = 'Premium';
            } else {
                tierBadge.className = 'px-2 py-0.5 rounded text-[10px] font-bold bg-slate-500/20 text-slate-400 border border-slate-500/30 uppercase';
                tierBadge.textContent = 'Free';
            }
            
            document.getElementById('detail-total').textContent = keyStat.total_requests.toLocaleString();
            document.getElementById('detail-latency').textContent = Math.round(keyStat.avg_response_time_ms) + 'ms';
            document.getElementById('detail-success').textContent = keyStat.success_requests.toLocaleString();
            document.getElementById('detail-errors').textContent = keyStat.error_requests.toLocaleString();
            
            // Update bar chart
            var keyDailyData = keyStat.daily_stats || [];
            var ctx = document.getElementById('keyDetailChart').getContext('2d');
            
            if (keyDetailChart) keyDetailChart.destroy();
            
            if (keyDailyData.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            keyDetailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: keyDailyData.map(function(d) { return d.date; }).reverse(),
                    datasets: [
                        {
                            label: 'Requests',
                            data: keyDailyData.map(function(d) { return d.count; }).reverse(),
                            backgroundColor: '#427cf0',
                            borderColor: '#427cf0',
                            borderWidth: 1
                        },
                        {
                            label: 'Success',
                            data: keyDailyData.map(function(d) { return d.success; }).reverse(),
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: 'Errors',
                            data: keyDailyData.map(function(d) { return d.error; }).reverse(),
                            backgroundColor: '#ef4444',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        }
                    }
                }
            });
        }
        
        // Handle key clicks
        document.querySelectorAll('.key-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var keyId = parseInt(this.dataset.keyId);
                selectedKeyId = keyId;
                
                document.querySelectorAll('.key-item').forEach(function(i) {
                    i.classList.remove('bg-primary/10', 'border-primary/30');
                    i.classList.add('border-transparent');
                });
                this.classList.add('bg-primary/10', 'border-primary/30');
                this.classList.remove('border-transparent');
                
                // Get data from script tag instead of data attribute
                var dataScript = this.querySelector('.key-data-json');
                if (!dataScript) return;
                
                try {
                    var keyStat = JSON.parse(dataScript.textContent);
                    updateDetailPanel(keyStat);
                } catch(e) {
                    console.error('Error parsing key data:', e);
                }
            });
        });
        
        // Auto-select first key
        function autoSelectFirstKey() {
            if (statsByKey && statsByKey.length > 0) {
                var firstItem = document.querySelector('.key-item');
                if (firstItem) {
                    setTimeout(function() {
                        firstItem.click();
                    }, 100);
                }
            }
        }
        
        // Search
        var searchInput = document.getElementById('key-search');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                var query = this.value.toLowerCase();
                document.querySelectorAll('.key-item').forEach(function(item) {
                    var prefix = (item.dataset.keyPrefix || '').toLowerCase();
                    var label = (item.dataset.keyLabel || '').toLowerCase();
                    item.style.display = (prefix.includes(query) || label.includes(query)) ? '' : 'none';
                });
            });
        }
        
        // Initialize everything when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initCharts();
                drawSparklines();
                autoSelectFirstKey();
            });
        } else {
            initCharts();
            drawSparklines();
            autoSelectFirstKey();
        }
    </script>
</body>
</html>
