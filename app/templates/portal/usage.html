{% extends "base.html" %}

{% block title %}Usage Stats - CCCD API{% endblock %}

{% block extra_css %}
<style>
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: var(--color-bg-secondary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--color-primary); }
    .stat-card h3 { font-size: 14px; color: var(--color-text-secondary); text-transform: uppercase; margin-bottom: 8px; }
    .stat-card .value { font-size: 32px; font-weight: 600; color: var(--color-text-primary); }
    .filter-bar { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; }
    .filter-bar label { font-weight: var(--font-weight-medium); }
    .filter-bar select { padding: var(--spacing-2) var(--spacing-3); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: var(--font-size-sm); }
    .chart-container { position: relative; height: 400px; margin-top: 20px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <div class="section card">
        <div class="card-header">
            <h2>Usage Statistics</h2>
        </div>
        <div class="card-body">
            <div class="filter-bar">
                <label>Xem trong:</label>
                <select id="days-filter" onchange="changeDays(this.value)">
                    <option value="7" {% if days == 7 %}selected{% endif %}>7 ngày</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>30 ngày</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>90 ngày</option>
                    <option value="365" {% if days == 365 %}selected{% endif %}>1 năm</option>
                </select>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Tổng requests</h3>
                    <div class="value">{{ stats.total_requests }}</div>
                </div>
                <div class="stat-card">
                    <h3>Thành công</h3>
                    <div class="value" style="color: var(--color-success-text);">{{ stats.success_requests }}</div>
                </div>
                <div class="stat-card">
                    <h3>Lỗi</h3>
                    <div class="value" style="color: var(--color-error-text);">{{ stats.error_requests }}</div>
                </div>
                <div class="stat-card">
                    <h3>Response time trung bình</h3>
                    <div class="value">{{ "%.0f"|format(stats.avg_response_time_ms) }}ms</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>
    
    {% if stats.status_code_breakdown %}
    <div class="section card">
        <div class="card-header">
            <h2>Status Code Breakdown</h2>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block extra_js %}
<script>
    // Daily requests chart
    const dailyData = {{ stats.daily_stats|tojson }};
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: dailyData.map(d => d.date).reverse(),
            datasets: [
                {
                    label: 'Tổng requests',
                    data: dailyData.map(d => d.count).reverse(),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Thành công',
                    data: dailyData.map(d => d.success).reverse(),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Lỗi',
                    data: dailyData.map(d => d.error).reverse(),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Requests theo ngày'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Status code chart
    {% if stats.status_code_breakdown %}
    const statusData = {{ stats.status_code_breakdown|tojson }};
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(statusData),
            datasets: [{
                label: 'Số lượng',
                data: Object.values(statusData),
                backgroundColor: [
                    '#28a745',  // 200
                    '#ffc107',  // 400
                    '#fd7e14',  // 401
                    '#dc3545'   // 500
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Phân bổ Status Code'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    {% endif %}
    
    function changeDays(days) {
        window.location.href = '{{ url_for("portal.usage") }}?days=' + days;
    }
</script>
{% endblock %}
